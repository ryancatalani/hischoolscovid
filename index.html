<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Hawaiʻi Public Schools: Reported COVID-19 Cases</title>
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
	  integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
	  crossorigin=""/>
	<link rel="stylesheet" type="text/css" href="main.css">
	<link rel="stylesheet" type="text/css" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css">
	<link rel="stylesheet" type="text/css" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css">

	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta charset="utf-8"> 

	<meta property="og:title" content="Hawaiʻi Public Schools: Reported COVID-19 Cases" />
	<meta property="og:description" content="See a list of all COVID-19 cases reported by school in the 2021-22 school year." />
	<meta property="og:image" content="https://rcpublic.s3.amazonaws.com/doecovidsocial.jpg" />

	<meta name="twitter:card" content="summary_large_image" />
	<meta name="twitter:site" content="@ryancatalani" />
	<meta name="twitter:title" content="Hawaiʻi Public Schools: Reported COVID-19 Cases" />
	<meta name="twitter:description" content="See a list of all COVID-19 cases reported by school in the 2021-22 school year." />
	<meta name="twitter:image" content="https://rcpublic.s3.amazonaws.com/doecovidsocial.jpg" />

	<meta name="description" content="See a list of all COVID-19 cases reported by school in the 2021-22 school year." />
</head>
<body>


	<div id="schoolMap"></div>
	<div id="mainContent">
		<header>
			<h1>Hawaiʻi Public Schools: Reported COVID-19 Cases</h1>
			<p>Compiled by Ryan Catalani (<a href="https://twitter.com/ryancatalani">@ryancatalani</a>)</p>

			<div id="aboutData">
				<p id="aboutDataHeader"><i class="fas fa-info-circle"></i> <strong>About the data & submit missing data</strong></p>
				<div id="aboutDataInner">
					<p>Last updated: Aug. 30, 2021</p>
					<p>This data is primarily compiled from the <a href="https://www.hawaiipublicschools.org/ConnectWithUs/MediaRoom/PressReleases/Pages/COVID-19-Information-Updates.aspx" target="_blank">weekly Department of Education releases</a>, starting from July 24, 2021.</p>
					<p>If you have any data that’s missing, or see something inaccurate, click here to <a href="/submit.html">submit additional data</a>. Public data submissions are indicated in the list below.</p>
					<p>School enrollment figures are from the 2020-21 school year, <a href="https://www.hawaiipublicschools.org/ConnectWithUs/MediaRoom/PressReleases/Pages/2020-21-enrollment.aspx" target="_blank">via the DOE</a>.</p>
					<p><a href="https://unofficialhidoecoviddashboard.hawaiicoder.com/" target="_blank">Click here</a> to see another community-drive visualization with this data by John Johnson.</p>
				</div>
			</div>

			<div id="filter">
				<label for="filterInput">Filter by school name:</label>
				<span id="filterInputWrap">
					<input type="text" name="filter" id="filterInput">
					<span id="filterClear"><i class="fas fa-times-circle"></i></span>
				</span>
			</div>
			<div id="sortBy">
				Sort by: <span class="sortKey active" data-key="total">Total cases reported</span> • <span class="sortKey" data-key="ratio">Ratio of cases to students</span>
			</div>
		</header>

		<div id="loading">
			<i class="fas fa-cog fa-spin"></i> Loading…
		</div>
		<div id="schoolList"></div>	
	</div>

	


	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" referrerpolicy="no-referrer"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.1/papaparse.min.js" integrity="sha512-EbdJQSugx0nVWrtyK3JdQQ/03mS3Q1UiAhRtErbwl1YL/+e2hZdlIcSURxxh7WXHTzn83sjlh2rysACoJGfb6g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.13.1/underscore-min.js" referrerpolicy="no-referrer"></script>
	<script src="https://d3js.org/d3-color.v1.min.js"></script>
	<script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
	<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
	<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
	  integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
	  crossorigin=""></script>
	<script src="https://kit.fontawesome.com/34652e81df.js" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js" integrity="sha512-KhIBJeCI4oTEeqOmRi2gDJ7m+JARImhUYgXWiOTIp9qqySpFUAJs09erGKem4E5IPuxxSTjavuurvBitBmwE0w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script type="text/javascript" src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
	<script type="text/javascript" src="/sparkline.js"></script>
	<script type="text/javascript">
		class School {
			constructor(args) {
				this.name = args.name;
				this.lat = args.lat;
				this.long = args.long;
				this.cumulative = args.cumulative;
				this.cumulativePublic = args.cumulativePublic;
				this.marker = args.marker;
				this.id = args.id;
				this.enrollment = args.enrollment;
			}
			safeName() {
				return createSafeName(this.name);
			}
			cumulativeText() {
				var text = this.cumulative;
				if (this.cumulativePublic !== undefined && this.cumulativePublic > 0) {
					var doeTotal = this.cumulative - this.cumulativePublic;
					text += " (DOE reported: " + doeTotal + ", "
					text += "public submissions: " + this.cumulativePublic + ")";
				}
				return text;
			}
			enrollmentText() {
				var text = "";
				if (this.enrollment !== undefined && this.cumulative !== undefined && this.enrollment > 0 && this.cumulative > 0) {
					var ratio = Math.round(this.caseRatio());
					text += "About 1 case for every " + ratio.toLocaleString() + " students. ";
					text += "<em>(SY20-21 enrollment: " + this.enrollment.toLocaleString() + ". Note that not all cases are from students.)<em>";
				}
				return text;
			}
			caseRatio() {
				if (this.enrollment !== undefined && this.cumulative !== undefined && this.enrollment > 0 && this.cumulative > 0) {
					return (1.0 * this.enrollment) / this.cumulative;	
				}
				return 0;
			}
			invertedRatio() {
				if (this.enrollment !== undefined && this.cumulative !== undefined && this.enrollment > 0 && this.cumulative > 0) {
					return (1.0 * this.cumulative) / this.enrollment;
				}
				return 0;	
			}
			element() {
				var template = _.template("<div class='school' data-name='<%= safeName %>'><div class='schoolName'><%= name %></div><div class='schoolDesc'>Total cases reported: <%= cumulative %><span class='zoomTo' data-lat='<%= lat %>' data-long='<%= long %>'><i class='fas fa-search-plus'></i> Zoom to this school</span></div><div class='schoolEnrollment'><%= enrollment %></div></div>");
				return template({
					name: this.name, 
					safeName: this.safeName(),
					cumulative: this.cumulativeText(),
					lat: this.lat,
					long: this.long,
					enrollment: this.enrollmentText()
				});
			}
		}
		class Case {
			constructor(args) {
				this.school = args.school;
				this.dateReported = args.dateReported;
				this.lastDateOnCampus = args.lastDateOnCampus;
				this.reportingPeriod = args.reportingPeriod;
				this.source = args.source;
				this.status = args.status;
				this.publicSubmission = args.publicSubmission;
				this.count = args.count;
			}
			sourceText() {
				if (this.publicSubmission) {
					return "Public submission";
				} else if (this.reportingPeriod !== undefined && this.reportingPeriod !== "") {
					return "DOE data • Reporting period: " + this.reportingPeriod;	
				}
				return "DOE data";
			}
			classText() {
				var c = "case";
				if (this.publicSubmission) {
					c += " publicSubmission";
				}
				return c;
			}
			caseText() {
				if (this.count > 1) {
					return "Cases (" + this.count + ")";
				}
				return "Case";
			}
			element() {
				var template = _.template("<div class='<%= classText %>'><p><strong><%= caseText %> <%= status %></strong></p><p>Date reported: <%= dateReported %></p><p>Last date individual was on campus: <%= lastDateOnCampus %></p><p>Source: <%= sourceText %></p><a href='<%= source %>' target='_blank'>View source</a>");
				return template({
					caseText: this.caseText(),
					classText: this.classText(),
					dateReported: this.dateReported,
					lastDateOnCampus: this.lastDateOnCampus,
					sourceText: this.sourceText(),
					source: this.source,
					status: this.status
				});
			}
		}

		// Globals

		var allSchools = [];
		var allCases = [];
		var months = ['January','February','March','April','May','June','July','August','September','October','November','December'];

		// Helpers

		function createSafeName(input) {
			return input.replace(/[^a-zA-Z]/gi, "").toLocaleUpperCase();
		}

		Date.prototype.addDays = function(days) {
		    var date = new Date(this.valueOf());
		    date.setDate(date.getDate() + days);
		    return date;
		}

		function getDates(startDate, stopDate) {
		    var dateArray = new Array();
		    var currentDate = startDate;
		    while (currentDate <= stopDate) {
		        dateArray.push(new Date (currentDate));
		        currentDate = currentDate.addDays(1);
		    }
		    return dateArray;
		}

		function findClosest(target, tagName) {
		  if (target.tagName === tagName) {
		    return target;
		  }

		  while ((target = target.parentNode)) {
		    if (target.tagName === tagName) {
		      break;
		    }
		  }

		  return target;
		}

		var sparklineOptions = {
		  onmousemove(event, datapoint) {
		    var svg = findClosest(event.target, "svg");
		    var tooltip = svg.nextElementSibling;
		    var date = datapoint.date;
		    var plur = datapoint.value === 1 ? "" : "s";

		    tooltip.hidden = false;
		    tooltip.textContent = `${date}: At least ${datapoint.value} total case${plur} reported`;
		    tooltip.style.top = `${event.offsetY - 23}px`;
		    tooltip.style.left = `${event.offsetX + 20}px`;
		  },

		  onmouseout() {
		    var svg = findClosest(event.target, "svg");
		    var tooltip = svg.nextElementSibling;
		    tooltip.hidden = true;
		  }
		};


		$(function() {

			// Set up map

			var windowWidth = $(window).width();
			var defaultZoom = 7;
			if ($(window).width  > 700) {
				defaultZoom = 8;
			}
			var calculateLayout = _.debounce(function(){
				windowWidth = $(window).width();
			}, 300);
			$(window).resize(calculateLayout);

			// https://github.com/Leaflet/Leaflet/issues/7255#issuecomment-849638476
			var schoolMap = L.map('schoolMap', {
				center: [21.311389, -157.796389],
				zoom: defaultZoom,
				"tap": false
			});

			L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
				attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
				subdomains: 'abcd',
				maxZoom: 19
			}).addTo(schoolMap);

			var markers = L.markerClusterGroup({
				iconCreateFunction: function(cluster) {
					return L.divIcon({ 
						html: '<div class="clusterIconCount"><strong>' + cluster.getChildCount() + '</strong> Schools</div>',
						className: "clusterIcon",
						iconSize: [40,40]
					});
				}
			});

			markers.on('clusterclick', function (a) {
				a.layer.zoomToBounds({padding: [20, 20]});
			});

			// Set up about data header

			$("#aboutDataHeader").click(function() {
				$("#aboutDataInner").slideToggle("fast");
			});

			// Set up filter

			var runFilter = _.debounce(function() {
				$("#loading").slideDown("fast");
				var input = createSafeName($("#filterInput").val());

				if (input == "") {
					$("#filterClear").hide();
					$("#loading").slideUp("fast");
					_(allSchools).each(function(school) {
						if (school.marker !== undefined && !markers.hasLayer(school.marker)) {
							var marker = school.marker;
							markers.addLayer(marker);
						}
					});
					return $(".school").show();
				}

				$("#filterClear").show();
				$(".school").each(function() {
					var name = $(this).data('name');
					var school = _(allSchools).find(function(s) {
						return s.safeName() == name;
					});
					
					var schoolHasMarker = false;
					var marker;
					if (school !== undefined && school.marker !== undefined ) {
						schoolHasMarker = true;
						marker = school.marker;
					}

					if (name.indexOf(input) >= 0) {
						$(this).show();
						if ( schoolHasMarker && !markers.hasLayer(marker) ) {
							markers.addLayer(marker);
						}
					} else {
						$(this).hide();
						if ( schoolHasMarker && markers.hasLayer(marker) ) {
							markers.removeLayer(marker);
						}
					}
				});
				$("#loading").slideUp("fast");
			}, 150);

			$("#filterInput").keyup(runFilter);
			$("#filterClear").click(function() {
				$("#filterInput").val("").trigger("keyup");
			})

			// Set up sorting

			$(".sortKey").click(function() {
				if ( $(this).hasClass("active") )
					return;

				$(".sortKey").removeClass("active");
				$("#schoolList").empty();

				var key = $(this).data("key");
				if (key === "total") {
					displayData({allSchools: allSchools});
				} else if (key === "ratio") {
					displayData({allSchools: allSchools, sortKey: "ratio"});
				}

				$(this).addClass("active");
			});

			// Set up Zoom

			$("#schoolList").on("click", ".zoomTo", function() {
				var lat = $(this).data("lat");
				var long = $(this).data("long");
				// schoolMap.flyTo([lat, long], 12, {duration: 0.2});

				var name = $(this).parents(".school").data("name");
				var school = _(allSchools).find(function(s) { return s.safeName() == name });
				if (school !== undefined && school.marker !== undefined ) {
					var marker = school.marker;
					markers.zoomToShowLayer(marker, function() {
						marker.openPopup();
					});
				}
			});

			// Set up data display

			function displayData(args) {
				var allSchools = args.allSchools;
				var schoolMap = args.schoolMap;
				var sortKey = args.sortKey;

				_.chain(allSchools).sortBy(function(school) {
					return school.name;
				}).reverse().sortBy(function(school) {
					if (sortKey === "ratio") {
						return school.invertedRatio();
					}
					return school.cumulative;
				}).reverse().each(function(school) {
					var $schoolEl = $(school.element());
					// Enable for case display
					$schoolEl.append("<div class='casesLabel'><strong>Individual cases</strong> <em>(Note that DOE data may not list every individual case.)</em></div><div class='casesOuter'><div class='casesInner'></div></div>");
					$("#schoolList").append( $schoolEl );

					if (schoolMap !== undefined) {
						if (school.lat !== undefined && school.long !== undefined) {
							var icon =  L.divIcon({
								className: 'marker-icon',
								html: '<i id="marker' + school.id + '" class="fas fa-map-pin fa-3x"></i>',
								iconSize: [20,36],
								iconAnchor: [10,36],
								popupAnchor: [0,-20]
							});

							var marker = L.marker([school.lat, school.long]);
							marker.bindPopup(school.element());
							// marker.addTo(schoolMap);
							markers.addLayer(marker);

							school.marker = marker;	
						}

						schoolMap.addLayer(markers);	
					}	

					// Enable for case display
					var sorted = _.chain(allCases).filter(function(theCase) {
						return theCase.school == school.name;
					}).each(function(theCase) {
						$schoolEl.find('.casesInner').append( theCase.element() );
						$schoolEl.find('.casesInner').css('width', 310 * school.cumulative + 'px');
					}).sort(function(theCase) {
						return new Date(theCase.dateReported);
					}).reverse().value();

					if (sorted.length > 0) {
						// Sparkline
						var caseMinDate = new Date(sorted[0].dateReported);
						var caseMaxDate = new Date(sorted[sorted.length - 1].dateReported);
						var dateRange = getDates(caseMinDate, caseMaxDate);
						var casesByDate = _.chain(sorted)
							.groupBy(function(c) { return c.dateReported })
							.mapObject(function(value) {
								var sum = _(value).reduce(function(memo, num) { return memo + num.count}, 0);
								return sum;
							})
							.value();
						
						var sparklineData = _(dateRange).map(function(d) {
							var dateStr = months[d.getMonth()] + " " + d.getDate() + ", " + d.getFullYear();
							var caseCount = casesByDate[dateStr];
							if (caseCount === undefined) {
								caseCount = 0;
							}
							return {date: dateStr, dailyValue: caseCount, value: 1};
						});
						// var cumulative = [0];
						_.chain(sparklineData)
							.map(function(d) { return d.dailyValue })
							.reduce(function(a,b,i){ 
								// return cumulative[i] = a+b;
								return sparklineData[i].value = a+b;
							});

						// var sparklineValues = _(sparklineData).map(function(d) {return d.value });

						var sparklineID = createSafeName("sparkline" + school.name);
						var $sparkline = $("<svg id='" + sparklineID + "' class='sparkline' width='80' height='16' stroke-width='2'></svg><span class='tooltip' hidden='true'></span>");
						$sparkline.insertBefore( $schoolEl.find(".zoomTo") );

						sparkline.sparkline(document.querySelector("#"+sparklineID), sparklineData, sparklineOptions);
					}

				});
			}

			// Set up data

			var totalsURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRYH-1yDrq_TA7k3IUYy0J7SVbSRO850SmeUjXVOo0K7PSPqdBXAsjgO4sjmpFLZ3vamRmUBZMWg2Iy/pub?gid=1726552848&single=true&output=csv";
			var casesURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRYH-1yDrq_TA7k3IUYy0J7SVbSRO850SmeUjXVOo0K7PSPqdBXAsjgO4sjmpFLZ3vamRmUBZMWg2Iy/pub?output=csv";
			var schoolsURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRYH-1yDrq_TA7k3IUYy0J7SVbSRO850SmeUjXVOo0K7PSPqdBXAsjgO4sjmpFLZ3vamRmUBZMWg2Iy/pub?gid=1271858449&single=true&output=csv";
			var crosswalkURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRYH-1yDrq_TA7k3IUYy0J7SVbSRO850SmeUjXVOo0K7PSPqdBXAsjgO4sjmpFLZ3vamRmUBZMWg2Iy/pub?gid=280592408&single=true&output=csv";

			function pparse(url) {
				var d = $.Deferred();
				Papa.parse(url, {
					download: true,
					header: true,
					complete: function(results) {
						d.resolve(results.data);
					}
				});
				return d.promise();
			}

			$.when( pparse(totalsURL), pparse(schoolsURL), pparse(crosswalkURL), pparse(casesURL) )
				.done(function(totalsData, schools, crosswalk, casesData) {

					// Parse data

					_(totalsData).each(function(row) {
						var school = new School({
							name: row.Name,
							cumulative: parseInt(row.Cases)
						});
						var schoolObj = _(schools).find(function(sch) {
							return sch.sch_name == school.name;
						});
						if (schoolObj !== undefined) {
							school.lat = parseFloat(schoolObj.Y);
							school.long = parseFloat(schoolObj.X);
							school.enrollment = parseInt(schoolObj.Enrollment);	
						}
						allSchools.push(school);
					});

					_(casesData).each(function(row) {
						var theCase = new Case({
							school: row["School"],
							dateReported: row["Date case reported"],
							reportingPeriod: row["Reporting period"],
							status: row["Case Status"],
							publicSubmission: row["Public Submission"] == "TRUE",
							count: parseInt(row.Count)
						});
						if (row["Last date on campus"] !== "Null") {
							theCase.lastDateOnCampus = row["Last date on campus"];
						} else {
							theCase.lastDateOnCampus = "Unspecified";
						}
						if (row.Source !== undefined && row.Source !== "") {
							theCase.source = row.Source;
						} else {
							theCase.source = "https://public.tableau.com/app/profile/hidoe.dga/viz/COVID-19HIDOECaseCountPublicDashboard/List";
						}

						allCases.push(theCase);
					});


					// Display data

					displayData({allSchools: allSchools, schoolMap: schoolMap});

					// Color markers

					var caseCounts = _(allSchools).map(function(school) { return parseInt(school.cumulative) }).sort(function(a, b) {
						return a-b;
					});
					var minCaseCount = caseCounts[0];
					var maxCaseCount = caseCounts[caseCounts.length-1];

					// Heatmap
					
					var heatmapPoints = _.chain(allSchools).filter(function(school) {
						return school.lat !== undefined && school.long !== undefined;
					}).map(function(school) {
						return [school.lat, school.long, school.cumulative];
					}).value();
					var heat = L.heatLayer(heatmapPoints, {
						max: maxCaseCount,
						maxZoom: 11,
						gradient: {0.2: '#2c7bb6',
							0.4: '#abd9e9',
							0.6: '#ffffbf',
							0.8: '#fdae61',
							1: '#d7191c'}
					}).addTo(schoolMap);

					$("#loading").slideUp("fast");

				});

		})
	</script>

	<script async src="https://www.googletagmanager.com/gtag/js?id=G-4X7GH9TRT2"></script>
	<script>
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());

	  gtag('config', 'G-4X7GH9TRT2');
	</script>

</body>
</html>